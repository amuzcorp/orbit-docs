export const metadata = {
  title: '엔티티',
  description: 'CMS-Orbit의 엔티티(Entities)에 대해 알아봅니다.',
}

export const sections = [
  { title: '엔티티 생성하기', id: 'creating-entities' },
  { title: '엔티티와 모델의 차이점', id: 'differences' },
  { title: '엔티티 예제', id: 'examples' },
  { title: '엔티티의 사용 사례', id: 'use-cases' },
]

# 엔티티

CMS-Orbit에서 엔티티를 생성하고 사용하는 방법을 알아봅니다. {{ className: 'lead' }}

## 엔티티 생성하기

### cms:entity 명령어 사용

```bash {{ title: '엔티티 생성 명령어' }}
php artisan cms:entity Category
```

이 명령어는 다음 파일들을 생성합니다:
- `app/Entities/Category.php`
- `app/Orchid/Resources/CategoryResource.php`

### 엔티티 클래스 구조

```php {{ title: '기본 엔티티 클래스' }}
namespace App\Entities;

use Orbit\Entities\Entity;
use Orbit\Traits\AsSource;
use Orbit\Traits\Filterable;

class Category extends Entity
{
    use AsSource, Filterable;

    protected $fillable = [
        'name',
        'slug',
        'description'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];
}
```

## 엔티티와 모델의 차이점

### 데이터베이스 테이블

```php {{ title: '엔티티와 모델의 데이터베이스 차이' }}
// 모델
class Post extends Model
{
    protected $table = 'posts';
}

// 엔티티
class Category extends Entity
{
    // 엔티티는 데이터베이스 테이블을 직접 관리하지 않음
    // 대신 모델을 통해 데이터를 처리
}
```

### 마이그레이션

```php {{ title: '엔티티와 모델의 마이그레이션 차이' }}
// 모델 마이그레이션
Schema::create('posts', function (Blueprint $table) {
    $table->id();
    $table->string('title');
    $table->text('content');
    $table->timestamps();
});

// 엔티티는 마이그레이션을 직접 생성하지 않음
// 대신 모델의 마이그레이션을 사용
```

### 사용 목적

```php {{ title: '엔티티와 모델의 사용 목적 차이' }}
// 모델: 데이터베이스와의 인터페이스
class Post extends Model
{
    // 데이터베이스 작업
    public function scopePublished($query)
    {
        return $query->where('status', 'published');
    }
}

// 엔티티: 비즈니스 로직 캡슐화
class Category extends Entity
{
    // 비즈니스 로직
    public function getActivePosts()
    {
        return $this->posts()
            ->where('status', 'published')
            ->where('is_active', true)
            ->get();
    }
}
```

## 엔티티 예제

### 카테고리 엔티티

```php {{ title: '카테고리 엔티티' }}
namespace App\Entities;

use Orbit\Entities\Entity;
use Orbit\Traits\AsSource;
use Orbit\Traits\Filterable;

class Category extends Entity
{
    use AsSource, Filterable;

    protected $fillable = [
        'name',
        'slug',
        'description',
        'parent_id',
        'order',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];

    public function parent()
    {
        return $this->belongsTo(Category::class, 'parent_id');
    }

    public function children()
    {
        return $this->hasMany(Category::class, 'parent_id');
    }

    public function posts()
    {
        return $this->hasMany(Post::class);
    }

    public function getActivePosts()
    {
        return $this->posts()
            ->where('status', 'published')
            ->where('is_active', true)
            ->get();
    }
}
```

### 태그 엔티티

```php {{ title: '태그 엔티티' }}
namespace App\Entities;

use Orbit\Entities\Entity;
use Orbit\Traits\AsSource;
use Orbit\Traits\Filterable;

class Tag extends Entity
{
    use AsSource, Filterable;

    protected $fillable = [
        'name',
        'slug',
        'description'
    ];

    public function posts()
    {
        return $this->belongsToMany(Post::class);
    }

    public function getPopularPosts($limit = 5)
    {
        return $this->posts()
            ->where('status', 'published')
            ->orderBy('view_count', 'desc')
            ->limit($limit)
            ->get();
    }
}
```

### 설정 엔티티

```php {{ title: '설정 엔티티' }}
namespace App\Entities;

use Orbit\Entities\Entity;
use Orbit\Traits\AsSource;

class Setting extends Entity
{
    use AsSource;

    protected $fillable = [
        'key',
        'value',
        'type',
        'group'
    ];

    protected $casts = [
        'value' => 'json'
    ];

    public static function getValue($key, $default = null)
    {
        $setting = static::where('key', $key)->first();
        return $setting ? $setting->value : $default;
    }

    public static function setValue($key, $value)
    {
        $setting = static::firstOrNew(['key' => $key]);
        $setting->value = $value;
        $setting->save();
        return $setting;
    }
}
```

## 엔티티의 사용 사례

### 계층 구조 관리

```php {{ title: '계층 구조 관리' }}
class Category extends Entity
{
    public function getHierarchy()
    {
        $hierarchy = [];
        $current = $this;

        while ($current) {
            array_unshift($hierarchy, $current);
            $current = $current->parent;
        }

        return $hierarchy;
    }

    public function getDescendants()
    {
        $descendants = collect();
        $children = $this->children;

        foreach ($children as $child) {
            $descendants->push($child);
            $descendants = $descendants->merge($child->getDescendants());
        }

        return $descendants;
    }
}
```

### 태그 시스템

```php {{ title: '태그 시스템' }}
class Tag extends Entity
{
    public function getRelatedTags($limit = 5)
    {
        return static::whereHas('posts', function ($query) {
            $query->whereIn('id', $this->posts()->pluck('id'));
        })
        ->where('id', '!=', $this->id)
        ->withCount('posts')
        ->orderBy('posts_count', 'desc')
        ->limit($limit)
        ->get();
    }

    public function getTagCloud()
    {
        return static::withCount('posts')
            ->orderBy('posts_count', 'desc')
            ->get()
            ->map(function ($tag) {
                return [
                    'name' => $tag->name,
                    'count' => $tag->posts_count,
                    'weight' => $this->calculateWeight($tag->posts_count)
                ];
            });
    }

    protected function calculateWeight($count)
    {
        $max = static::withCount('posts')->max('posts_count');
        return ceil(($count / $max) * 5);
    }
}
```

### 설정 관리

```php {{ title: '설정 관리' }}
class Setting extends Entity
{
    public static function getGroup($group)
    {
        return static::where('group', $group)
            ->get()
            ->mapWithKeys(function ($setting) {
                return [$setting->key => $setting->value];
            });
    }

    public static function setGroup($group, array $values)
    {
        foreach ($values as $key => $value) {
            static::setValue("{$group}.{$key}", $value);
        }
    }

    public static function getSiteSettings()
    {
        return static::getGroup('site');
    }

    public static function getThemeSettings()
    {
        return static::getGroup('theme');
    }
}
```

<div className="not-prose">
  <Button href="/data-types/documents" variant="text" arrow="right">
    <>문서 알아보기</>
  </Button>
</div> 