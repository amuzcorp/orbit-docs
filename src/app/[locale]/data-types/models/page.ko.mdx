export const metadata = {
  title: '모델',
  description: 'CMS-Orbit의 모델(Model)에 대해 알아봅니다.',
}

export const sections = [
  { title: '모델 생성하기', id: 'creating-models' },
  { title: '기본 모델 구조', id: 'basic-model-structure' },
  { title: '모델의 주요 특징', id: 'key-features' },
  { title: '모델과 리소스의 관계', id: 'model-resource-relationship' },
]

# 모델

CMS-Orbit에서 모델을 생성하고 사용하는 방법을 알아봅니다. {{ className: 'lead' }}

## 모델 생성하기

### cms:model 명령어 사용

```bash {{ title: '모델 생성 명령어' }}
php artisan cms:model Post
```

이 명령어는 다음 파일들을 생성합니다:
- `app/Models/Post.php`
- `database/migrations/YYYY_MM_DD_create_posts_table.php`
- `app/Orchid/Resources/PostResource.php`

### 모델 클래스 구조

```php {{ title: '기본 모델 클래스' }}
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Orbit\Traits\AsSource;
use Orbit\Traits\Filterable;
use Orbit\Traits\Attachable;

class Post extends Model
{
    use AsSource, Filterable, Attachable;

    protected $fillable = [
        'title',
        'content',
        'status'
    ];

    protected $casts = [
        'published_at' => 'datetime',
        'is_featured' => 'boolean'
    ];
}
```

### 마이그레이션 생성

```php {{ title: '기본 마이그레이션' }}
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->string('title');
            $table->text('content');
            $table->string('status')->default('draft');
            $table->timestamp('published_at')->nullable();
            $table->boolean('is_featured')->default(false);
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('posts');
    }
};
```

## 기본 모델 구조

### 모델 클래스 상속

```php {{ title: '모델 상속' }}
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Orbit\Traits\AsSource;

class BaseModel extends Model
{
    use AsSource;

    protected $guarded = [];

    public static function boot()
    {
        parent::boot();
        
        static::creating(function ($model) {
            // 모델 생성 전 로직
        });
    }
}
```

### 트레이트 사용법

```php {{ title: '트레이트 사용' }}
use Orbit\Traits\AsSource;
use Orbit\Traits\Filterable;
use Orbit\Traits\Attachable;

class Post extends Model
{
    use AsSource, Filterable, Attachable;

    // AsSource 트레이트
    public function getSourceName(): string
    {
        return 'posts';
    }

    // Filterable 트레이트
    public function scopePublished($query)
    {
        return $query->where('status', 'published');
    }

    // Attachable 트레이트
    public function attachments()
    {
        return $this->morphMany(Attachment::class, 'attachable');
    }
}
```

### 속성 정의

```php {{ title: '속성 정의' }}
class Post extends Model
{
    // 채울 수 있는 속성
    protected $fillable = [
        'title',
        'content',
        'status'
    ];

    // 숨길 속성
    protected $hidden = [
        'password',
        'remember_token'
    ];

    // 타입 캐스팅
    protected $casts = [
        'is_active' => 'boolean',
        'options' => 'array',
        'published_at' => 'datetime'
    ];

    // 기본값
    protected $attributes = [
        'status' => 'draft',
        'is_featured' => false
    ];
}
```

### 관계 정의

```php {{ title: '관계 정의' }}
class Post extends Model
{
    // 일대일 관계
    public function author()
    {
        return $this->belongsTo(User::class);
    }

    // 일대다 관계
    public function comments()
    {
        return $this->hasMany(Comment::class);
    }

    // 다대다 관계
    public function tags()
    {
        return $this->belongsToMany(Tag::class);
    }

    // 다형성 관계
    public function attachments()
    {
        return $this->morphMany(Attachment::class, 'attachable');
    }
}
```

## 모델의 주요 특징

### AsSource 트레이트

```php {{ title: 'AsSource 트레이트' }}
use Orbit\Traits\AsSource;

class Post extends Model
{
    use AsSource;

    public function getSourceName(): string
    {
        return 'posts';
    }

    public function getSourceFields(): array
    {
        return [
            'title' => '제목',
            'content' => '내용',
            'status' => '상태'
        ];
    }
}
```

### Filterable 트레이트

```php {{ title: 'Filterable 트레이트' }}
use Orbit\Traits\Filterable;

class Post extends Model
{
    use Filterable;

    public function scopePublished($query)
    {
        return $query->where('status', 'published');
    }

    public function scopeFeatured($query)
    {
        return $query->where('is_featured', true);
    }

    public function scopeRecent($query)
    {
        return $query->orderBy('created_at', 'desc');
    }
}
```

### Attachable 트레이트

```php {{ title: 'Attachable 트레이트' }}
use Orbit\Traits\Attachable;

class Post extends Model
{
    use Attachable;

    public function attachments()
    {
        return $this->morphMany(Attachment::class, 'attachable');
    }

    public function getAttachableConfig(): array
    {
        return [
            'image' => [
                'max_size' => 2048,
                'mime_types' => ['image/jpeg', 'image/png']
            ],
            'document' => [
                'max_size' => 5120,
                'mime_types' => ['application/pdf']
            ]
        ];
    }
}
```

### 이벤트 시스템

```php {{ title: '이벤트 시스템' }}
class Post extends Model
{
    protected static function booted()
    {
        static::creating(function ($post) {
            // 생성 전
        });

        static::created(function ($post) {
            // 생성 후
        });

        static::updating(function ($post) {
            // 업데이트 전
        });

        static::updated(function ($post) {
            // 업데이트 후
        });

        static::deleting(function ($post) {
            // 삭제 전
        });

        static::deleted(function ($post) {
            // 삭제 후
        });
    }
}
```

## 모델과 리소스의 관계

### Orchid 리소스 생성

```php {{ title: 'Orchid 리소스 생성' }}
namespace App\Orchid\Resources;

use App\Models\Post;
use Orchid\Screen\Fields\Input;
use Orchid\Screen\Fields\TextArea;
use Orchid\Screen\Fields\Select;
use Orchid\Screen\Sight;
use Orchid\Crud\Resource;

class PostResource extends Resource
{
    public static $model = Post::class;

    public function fields(): array
    {
        return [
            Input::make('title')
                ->title('제목')
                ->required(),

            TextArea::make('content')
                ->title('내용')
                ->required(),

            Select::make('status')
                ->title('상태')
                ->options([
                    'draft' => '초안',
                    'published' => '발행'
                ])
                ->required()
        ];
    }

    public function columns(): array
    {
        return [
            'id',
            'title',
            'status',
            'created_at'
        ];
    }

    public function legend(): array
    {
        return [
            Sight::make('id', 'ID'),
            Sight::make('title', '제목'),
            Sight::make('content', '내용'),
            Sight::make('status', '상태'),
            Sight::make('created_at', '생성일')
        ];
    }
}
```

### 리소스 설정

```php {{ title: '리소스 설정' }}
class PostResource extends Resource
{
    public static $model = Post::class;

    public static function permission(): ?string
    {
        return 'platform.posts';
    }

    public static function icon(): string
    {
        return 'docs';
    }

    public static function label(): string
    {
        return '게시물';
    }

    public static function singularLabel(): string
    {
        return '게시물';
    }
}
```

### 화면 구성

```php {{ title: '화면 구성' }}
class PostResource extends Resource
{
    public function layout(): array
    {
        return [
            Layout::rows([
                Input::make('title')
                    ->title('제목')
                    ->required(),

                TextArea::make('content')
                    ->title('내용')
                    ->required(),

                Select::make('status')
                    ->title('상태')
                    ->options([
                        'draft' => '초안',
                        'published' => '발행'
                    ])
                    ->required()
            ])
        ];
    }

    public function filters(): array
    {
        return [
            Filter::make('status')
                ->title('상태')
                ->options([
                    'draft' => '초안',
                    'published' => '발행'
                ]),

            Filter::make('featured')
                ->title('추천')
                ->checkbox()
        ];
    }
}
```

<div className="not-prose">
  <Button href="/data-types/entities" variant="text" arrow="right">
    <>엔티티 알아보기</>
  </Button>
</div> 