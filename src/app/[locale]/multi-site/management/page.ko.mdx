export const metadata = {
  title: '사이트 관리',
  description: 'CMS-Orbit의 사이트 관리 방법에 대해 알아봅니다.',
}

export const sections = [
  { title: '사이트 생성', id: 'site-creation' },
  { title: '사이트 설정', id: 'site-configuration' },
  { title: '사이트 인식', id: 'site-identification' },
]

# 사이트 관리

CMS-Orbit에서 사이트를 생성하고 관리하는 방법을 알아봅니다. {{ className: 'lead' }}

## 사이트 생성

### tenancy:create 명령어

```bash {{ title: '사이트 생성 명령어' }}
php artisan tenancy:create site-a example.com
```

이 명령어는 다음 작업을 수행합니다:
- 사이트 데이터베이스 생성
- 사이트 설정 초기화
- 기본 테마 설치
- 기본 사용자 생성

### 사이트 설정

```php {{ title: '사이트 설정' }}
use Orbit\Tenancy\Tenant;

$tenant = Tenant::create([
    'id' => 'site-a',
    'domain' => 'example.com',
    'database' => [
        'name' => 'tenant_site_a',
        'username' => 'root',
        'password' => '',
    ],
    'settings' => [
        'site_name' => '사이트 A',
        'theme' => 'default',
        'locale' => 'ko',
    ],
]);
```

### 데이터베이스 생성

```php {{ title: '데이터베이스 생성' }}
use Orbit\Tenancy\Tenant;

$tenant = Tenant::find('site-a');

$tenant->run(function () {
    // 데이터베이스 마이그레이션
    Artisan::call('migrate');

    // 기본 데이터 시드
    Artisan::call('db:seed');

    // 사이트 설정 초기화
    Setting::setGroup('site', [
        'name' => '사이트 A',
        'description' => '사이트 A 설명',
        'keywords' => '사이트, A',
    ]);
});
```

## 사이트 설정

### config/tenancy.php 설정

```php {{ title: '테넌시 설정' }}
return [
    'tenant_domains' => [
        'example.com',
        '*.example.com',
    ],
    'database' => [
        'based_on' => 'domain',
        'prefix' => 'tenant_',
        'suffix' => '',
    ],
    'filesystem' => [
        'disk' => 'local',
        'root_override' => [
            'local' => '%storage_path%/app/tenants/%tenant_id%',
            'public' => '%storage_path%/app/public/tenants/%tenant_id%',
        ],
    ],
    'cache' => [
        'tag_base' => 'tenant',
    ],
    'queue' => [
        'tag_base' => 'tenant',
    ],
];
```

### 도메인 설정

```php {{ title: '도메인 설정' }}
use Orbit\Tenancy\Tenant;

$tenant = Tenant::find('site-a');

// 도메인 추가
$tenant->domains()->create([
    'domain' => 'www.example.com',
]);

// 도메인 제거
$tenant->domains()->where('domain', 'www.example.com')->delete();

// 기본 도메인 설정
$tenant->domains()->update(['is_primary' => false]);
$tenant->domains()->where('domain', 'example.com')->update(['is_primary' => true]);
```

### 데이터베이스 설정

```php {{ title: '데이터베이스 설정' }}
use Orbit\Tenancy\Tenant;

$tenant = Tenant::find('site-a');

// 데이터베이스 연결 설정
$tenant->database()->setConnection([
    'driver' => 'mysql',
    'host' => 'localhost',
    'port' => 3306,
    'database' => 'tenant_site_a',
    'username' => 'root',
    'password' => '',
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
]);

// 데이터베이스 백업
$tenant->database()->backup();

// 데이터베이스 복원
$tenant->database()->restore('backup.sql');
```

## 사이트 인식

### 현재 사이트 확인

```php {{ title: '현재 사이트 확인' }}
use Orbit\Tenancy\Tenant;

// 현재 사이트 확인
$tenant = Tenant::current();

// 사이트 정보 조회
$id = $tenant->id;
$domain = $tenant->domain;
$settings = $tenant->settings;
```

### 사이트 컨텍스트

```php {{ title: '사이트 컨텍스트' }}
use Orbit\Tenancy\Tenant;

$tenant = Tenant::find('site-a');

// 사이트 컨텍스트에서 실행
$tenant->run(function () {
    // 현재 사이트의 데이터베이스 사용
    $posts = Post::all();
    $users = User::all();
});

// 사이트 컨텍스트에서 예외 처리
try {
    $tenant->run(function () {
        // 사이트 관련 작업
    });
} catch (\Exception $e) {
    // 예외 처리
}
```

### 사이트 스위칭

```php {{ title: '사이트 스위칭' }}
use Orbit\Tenancy\Tenant;

// 사이트 A로 스위칭
Tenant::switchTo('site-a', function () {
    $posts = Post::all();
});

// 사이트 B로 스위칭
Tenant::switchTo('site-b', function () {
    $posts = Post::all();
});

// 모든 사이트에서 실행
Tenant::all()->each(function ($tenant) {
    $tenant->run(function () {
        // 각 사이트에서 실행
    });
});
```

### 사이트 미들웨어

```php {{ title: '사이트 미들웨어' }}
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Orbit\Tenancy\Tenant;

class InitializeTenancy
{
    public function handle(Request $request, Closure $next)
    {
        // 도메인으로 사이트 식별
        $tenant = Tenant::findByDomain($request->getHost());
        
        if (!$tenant) {
            abort(404, '사이트를 찾을 수 없습니다.');
        }

        // 사이트 초기화
        $tenant->initialize();

        return $next($request);
    }
}
```

### 사이트 이벤트

```php {{ title: '사이트 이벤트' }}
use Orbit\Tenancy\Events\TenantCreated;
use Orbit\Tenancy\Events\TenantUpdated;
use Orbit\Tenancy\Events\TenantDeleted;

// 사이트 생성 이벤트
Event::listen(TenantCreated::class, function ($event) {
    $tenant = $event->tenant;
    // 사이트 생성 후 처리
});

// 사이트 업데이트 이벤트
Event::listen(TenantUpdated::class, function ($event) {
    $tenant = $event->tenant;
    // 사이트 업데이트 후 처리
});

// 사이트 삭제 이벤트
Event::listen(TenantDeleted::class, function ($event) {
    $tenant = $event->tenant;
    // 사이트 삭제 후 처리
});
```

<div className="not-prose">
  <Button href="/multi-site/isolation" variant="text" arrow="right">
    <>사이트 격리 알아보기</>
  </Button>
</div> 